<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테트리스 P2P</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #lobby { display: none; }
    </style>
</head>
<body>
    <h1>테트리스 P2P</h1>
    <div id="main-menu">
        <button id="create-room">방 만들기</button>
        <input type="text" id="room-code" placeholder="방 코드 입력">
        <button id="join-room">방 들어가기</button>
    </div>
    <div id="lobby">
        <h2>대기실</h2>
        <p id="waiting-message">대기 중...</p>
    </div>

    <script>
        let rooms = {};
        let localPeerConnection;
        let remotePeerConnection;

        document.getElementById('create-room').addEventListener('click', () => {
            const roomCode = generateRoomCode();
            rooms[roomCode] = [];
            enterLobby(roomCode);
            setupPeerConnection();
        });

        document.getElementById('join-room').addEventListener('click', () => {
            const roomCode = document.getElementById('room-code').value;
            if (rooms[roomCode]) {
                enterLobby(roomCode);
                setupPeerConnection();
            } else {
                alert('존재하지 않는 방 코드입니다.');
            }
        });

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function enterLobby(roomCode) {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
            document.getElementById('waiting-message').innerText = `${roomCode} 대기실`;
        }

        function setupPeerConnection() {
            localPeerConnection = new RTCPeerConnection();
            remotePeerConnection = new RTCPeerConnection();

            localPeerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    remotePeerConnection.addIceCandidate(event.candidate);
                }
            };

            remotePeerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    localPeerConnection.addIceCandidate(event.candidate);
                }
            };

            // 데이터 채널 설정
            const dataChannel = localPeerConnection.createDataChannel('gameData');
            dataChannel.onopen = () => {
                console.log('Data channel opened');
            };

            remotePeerConnection.ondatachannel = (event) => {
                const receiveChannel = event.channel;
                receiveChannel.onmessage = (e) => {
                    console.log('Received message: ', e.data);
                };
            };

            // Offer/Answer
            localPeerConnection.createOffer().then((offer) => {
                return localPeerConnection.setLocalDescription(offer);
            }).then(() => {
                return remotePeerConnection.setRemoteDescription(localPeerConnection.localDescription);
            }).then(() => {
                return remotePeerConnection.createAnswer();
            }).then((answer) => {
                return remotePeerConnection.setLocalDescription(answer);
            }).then(() => {
                return localPeerConnection.setRemoteDescription(remotePeerConnection.localDescription);
            }).catch(console.error);
        }
    </script>
</body>
</html>
