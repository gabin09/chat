<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Tetris</title>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
        canvas { border: 1px solid black; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="300" height="600"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 게임 설정
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        let grid = Array.from({ length: ROWS }, () => Array(COLS).fill(0));

        let localConnection;
        let remoteConnection;
        let sendChannel;
        let receiveChannel;

        function setupConnection() {
            localConnection = new RTCPeerConnection();
            remoteConnection = new RTCPeerConnection();

            sendChannel = localConnection.createDataChannel("sendChannel");
            sendChannel.onopen = onSendChannelStateChange;
            sendChannel.onclose = onSendChannelStateChange;

            remoteConnection.ondatachannel = receiveChannelCallback;

            localConnection.onicecandidate = e => {
                if (e.candidate) {
                    remoteConnection.addIceCandidate(e.candidate);
                }
            };

            remoteConnection.onicecandidate = e => {
                if (e.candidate) {
                    localConnection.addIceCandidate(e.candidate);
                }
            };

            localConnection.createOffer()
                .then(offer => {
                    return localConnection.setLocalDescription(offer);
                })
                .then(() => {
                    return remoteConnection.setRemoteDescription(localConnection.localDescription);
                })
                .then(() => {
                    return remoteConnection.createAnswer();
                })
                .then(answer => {
                    return remoteConnection.setLocalDescription(answer);
                })
                .then(() => {
                    return localConnection.setRemoteDescription(remoteConnection.localDescription);
                });
        }

        function receiveChannelCallback(event) {
            receiveChannel = event.channel;
            receiveChannel.onmessage = onReceiveMessage;
        }

        function onSendChannelStateChange() {
            // 상태 변경 처리
        }

        function onReceiveMessage(event) {
            // 게임 상태 업데이트
            console.log("Received message: ", event.data);
            // 예: grid 업데이트 로직 추가
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c]) {
                        ctx.fillStyle = 'blue';
                        ctx.fillRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                    }
                }
            }
        }

        // 게임 시작
        setupConnection();
        setInterval(draw, 100);
    </script>
</body>
</html>
